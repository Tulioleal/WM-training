# ============================================================================
# Training Job - Entrenamiento incremental de YOLOv8
# ============================================================================
# Uso:
#   kubectl apply -f k8s/training-job.yaml
#
# Flujo automático:
#   1. Consulta la DB para saber cuándo fue el último training
#   2. Si es el primer training → usa todas las inferencias verificadas
#   3. Si hay trainings previos → usa solo inferencias nuevas desde el último
#   4. Descarga modelo latest de GCS como base para fine-tuning
#   5. Entrena, evalúa, sube modelo a GCS y registra en DB
#   6. Actualiza el modelo "latest" en GCS
#
# Después del training, reiniciar la API para cargar el nuevo modelo:
#   kubectl rollout restart deployment/inference-api -n waste-detection
# ============================================================================

apiVersion: batch/v1
kind: Job
metadata:
  generateName: training-job-
  namespace: waste-detection
spec:
  backoffLimit: 2
  ttlSecondsAfterFinished: 86400  # Se limpia después de 24h
  template:
    spec:
      serviceAccountName: waste-detection-app-sa
      tolerations:
        - key: workload
          operator: Equal
          value: training
          effect: NoSchedule
      containers:
        - name: training
          image: us-central1-docker.pkg.dev/waste-detection-001/waste-detection-prod/training:latest
          args:
            - "--from-inferences"
            - "--only-verified"
            - "--epochs=50"
            - "--batch-size=16"
            - "--patience=10"
          envFrom:
            - configMapRef:
                name: infra-config
            - secretRef:
                name: db-credentials
          resources:
            requests:
              cpu: "2"
              memory: "8Gi"
              nvidia.com/gpu: 1
            limits:
              cpu: "4"
              memory: "12Gi"
              nvidia.com/gpu: 1
      restartPolicy: Never